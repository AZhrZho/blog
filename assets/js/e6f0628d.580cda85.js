"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[156],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>d});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},c=Object.keys(e);for(r=0;r<c.length;r++)n=c[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(r=0;r<c.length;r++)n=c[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=r.createContext({}),u=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):p(p({},t),e)),n},s=function(e){var t=u(e.components);return r.createElement(o.Provider,{value:t},e.children)},D="mdxType",l={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},_=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,c=e.originalType,o=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),D=u(n),_=a,d=D["".concat(o,".").concat(_)]||D[_]||l[_]||c;return n?r.createElement(d,p(p({ref:t},s),{},{components:n})):r.createElement(d,p({ref:t},s))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var c=n.length,p=new Array(c);p[0]=_;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i[D]="string"==typeof e?e:a,p[1]=i;for(var u=2;u<c;u++)p[u]=n[u];return r.createElement.apply(null,p)}return r.createElement.apply(null,n)}_.displayName="MDXCreateElement"},8332:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>p,default:()=>l,frontMatter:()=>c,metadata:()=>i,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const c={slug:"desktop-stream-capture",title:"\u57fa\u4e8eDDA\u548cFFMPEG\u7684\u9ad8\u6027\u80fd\u684c\u9762\u6d41\u6355\u83b7",authors:"AZ",tags:["c++","windows","ffmpeg"]},p=void 0,i={permalink:"/blog/desktop-stream-capture",source:"@site/blog/2023-10-09-desktop-stream-capture/index.md",title:"\u57fa\u4e8eDDA\u548cFFMPEG\u7684\u9ad8\u6027\u80fd\u684c\u9762\u6d41\u6355\u83b7",description:"\u672c\u6587\u4ecb\u7ecd\u4e00\u79cd\u57fa\u4e8eWindows\u684c\u9762\u590d\u5236API\u548cFFMPEG\u7684\u9ad8\u6027\u80fd\u684c\u9762\u6d41\u6355\u83b7\u65b9\u6cd5\uff0c\u5176\u7279\u70b9\u5728\u4e8e\u5c4f\u5e55\u6355\u83b7\u548c\u89c6\u9891\u7f16\u7801\u5168\u90e8\u5728GPU\u4e0a\u8fdb\u884c\uff0c\u4e0e\u4f20\u7edf\u7684\u57fa\u4e8eGDI\u7684\u65b9\u5f0f\u76f8\u6bd4\uff0c\u6548\u7387\u66f4\u9ad8\u4e14\u4e0d\u5360\u7528CPU\u8d44\u6e90\u3002\u8be5\u65b9\u6cd5\u53ef\u7528\u4e8e\u684c\u9762\u5f55\u5236\u3001\u8fdc\u7a0b\u684c\u9762\u8f6f\u4ef6\u7b49\u3002",date:"2023-10-09T00:00:00.000Z",formattedDate:"October 9, 2023",tags:[{label:"c++",permalink:"/blog/tags/c"},{label:"windows",permalink:"/blog/tags/windows"},{label:"ffmpeg",permalink:"/blog/tags/ffmpeg"}],readingTime:7.17,hasTruncateMarker:!0,authors:[{name:"zhuoqiang.li",title:"\u662f\u4e2a\u5b66\u751f",url:"https://github.com/AZhrZho",imageURL:"https://github.com/AZhrZho.png",key:"AZ"}],frontMatter:{slug:"desktop-stream-capture",title:"\u57fa\u4e8eDDA\u548cFFMPEG\u7684\u9ad8\u6027\u80fd\u684c\u9762\u6d41\u6355\u83b7",authors:"AZ",tags:["c++","windows","ffmpeg"]},nextItem:{title:"\u5982\u4f55\u4f18\u96c5\u5730\u4e3aWPF\u6dfb\u52a0\u4f9d\u8d56\u6ce8\u5165",permalink:"/blog/run-wpf-on-generic-host"}},o={authorsImageUrls:[void 0]},u=[{value:"\u5728FFMPEG\u4e2d\u521b\u5efaD3D11\u5bf9\u8c61",id:"\u5728ffmpeg\u4e2d\u521b\u5efad3d11\u5bf9\u8c61",level:2},{value:"DXGI\u5c4f\u5e55\u6355\u83b7",id:"dxgi\u5c4f\u5e55\u6355\u83b7",level:2},{value:"\u521b\u5efaFFMPEG\u786c\u4ef6\u7f16\u7801\u5668",id:"\u521b\u5efaffmpeg\u786c\u4ef6\u7f16\u7801\u5668",level:2},{value:"\u521b\u5efa\u684c\u9762\u5e27\u7f13\u5b58\u548cFFPMEG\u7f16\u7801\u5668\u5e27\u7f13\u5b58",id:"\u521b\u5efa\u684c\u9762\u5e27\u7f13\u5b58\u548cffpmeg\u7f16\u7801\u5668\u5e27\u7f13\u5b58",level:2},{value:"\u5faa\u73af\u7f16\u7801\u5e76\u5199\u5165\u6587\u4ef6\u6d41",id:"\u5faa\u73af\u7f16\u7801\u5e76\u5199\u5165\u6587\u4ef6\u6d41",level:2}],s={toc:u},D="wrapper";function l(e){let{components:t,...c}=e;return(0,a.kt)(D,(0,r.Z)({},s,c,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u672c\u6587\u4ecb\u7ecd\u4e00\u79cd\u57fa\u4e8eWindows\u684c\u9762\u590d\u5236API\u548cFFMPEG\u7684\u9ad8\u6027\u80fd\u684c\u9762\u6d41\u6355\u83b7\u65b9\u6cd5\uff0c\u5176\u7279\u70b9\u5728\u4e8e\u5c4f\u5e55\u6355\u83b7\u548c\u89c6\u9891\u7f16\u7801\u5168\u90e8\u5728GPU\u4e0a\u8fdb\u884c\uff0c\u4e0e\u4f20\u7edf\u7684\u57fa\u4e8eGDI\u7684\u65b9\u5f0f\u76f8\u6bd4\uff0c\u6548\u7387\u66f4\u9ad8\u4e14\u4e0d\u5360\u7528CPU\u8d44\u6e90\u3002\u8be5\u65b9\u6cd5\u53ef\u7528\u4e8e\u684c\u9762\u5f55\u5236\u3001\u8fdc\u7a0b\u684c\u9762\u8f6f\u4ef6\u7b49\u3002"),(0,a.kt)("h1",{id:"windows\u684c\u9762\u590d\u5236api"},"Windows\u684c\u9762\u590d\u5236API"),(0,a.kt)("p",null,"Windows\u684c\u9762\u590d\u5236API\u662fWindows8\u5f00\u59cb\u652f\u6301\u7684\u4e00\u5957\u65b0\u7684API\uff0c\u63d0\u4f9b\u5bf9\u684c\u9762\u6620\u50cf\u7684\u8fdc\u7a0b\u8bbf\u95ee\u80fd\u529b\u3002\u8be5API\u76f4\u63a5\u5728DXGI\u56fe\u9762\u4e2d\u63a5\u6536\u684c\u9762\u7684\u66f4\u65b0\uff08\u5e95\u5c42\u663e\u793a\u8bbe\u5907\uff09\uff0c\u56e0\u6b64\u6027\u80fd\u6781\u9ad8\u3002\u7ecf\u6d4b\u8bd5\uff0c",(0,a.kt)("strong",{parentName:"p"},"\u5229\u7528\u8be5API\u53ef\u5b9e\u73b0200FPS\u4ee5\u4e0a\u7684\u684c\u9762\u56fe\u50cf\u6355\u83b7\uff0c\u4f5c\u4e3a\u5bf9\u6bd4\uff0c\u4f20\u7edf\u7684GDI\u6355\u83b7\u6700\u9ad8\u53ea\u80fd\u8fbe\u523030FPS\u3002")),(0,a.kt)("h1",{id:"ffmpeg\u7f16\u7801\u5668"},"FFMPEG\u7f16\u7801\u5668"),(0,a.kt)("p",null,"FFMPEG\u652f\u6301\u4f7f\u7528\u786c\u4ef6\u7f16\u7801\u5668\uff0cNVDIA\u663e\u5361\u53ef\u4ee5\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"nvenc"),"\uff0cAMD\u663e\u5361\u53ef\u4ee5\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"amf"),"\u3002\u672c\u6587\u4e2d\u5b9e\u73b0\u7684\u5173\u952e\u5728\u4e8e\u5982\u4f55\u5c06DXGI\u8f93\u51fa\u7684\u6570\u636e",(0,a.kt)("strong",{parentName:"p"},"\u76f4\u63a5\u9001\u5165\u786c\u4ef6\u7f16\u7801\u5668\uff0c\u907f\u514d\u663e\u5b58\u4e0e\u5185\u5b58\u95f4\u4e0d\u5fc5\u8981\u7684\u62f7\u8d1d"),"\u3002"),(0,a.kt)("h1",{id:"\u6838\u5fc3\u5b9e\u73b0"},"\u6838\u5fc3\u5b9e\u73b0"),(0,a.kt)("h2",{id:"\u5728ffmpeg\u4e2d\u521b\u5efad3d11\u5bf9\u8c61"},"\u5728FFMPEG\u4e2d\u521b\u5efaD3D11\u5bf9\u8c61"),(0,a.kt)("p",null,"DXGI\u7684\u684c\u9762\u6355\u83b7\u4f9d\u8d56D3D11\uff0c\u4e3a\u4e86\u80fd\u591f\u5c06\u6355\u83b7\u5230\u7684\u6570\u636e\u76f4\u63a5\u4ea4\u7ed9FFMPEG\u7684\u786c\u7f16\u7801\u5668\u5904\u7406\uff0c\u5fc5\u987b\u4f7f\u7528FFMPEG\u521b\u5efaD3D11\u8bbe\u5907\u5bf9\u8c61\uff0c\u800c\u4e0d\u80fd\u6211\u4eec\u81ea\u5df1\u521b\u5efa\uff08\u56e0\u4e3a\u4e0d\u540cD3D11\u5bf9\u8c61\u7684\u6570\u636e\u4e0d\u80fd\u76f4\u63a5\u8c03\u7528\uff09\uff0c\u4ee3\u7801\u5982\u4e0b\uff08\u7701\u7565\u5f02\u5e38\u5904\u7406\uff09\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},"    int ret = 0;\n    AVBufferRef* device_ref = NULL;\n    ret = av_hwdevice_ctx_create(&device_ref, AV_HWDEVICE_TYPE_D3D11VA, NULL, NULL, 0);\n    ret = av_hwdevice_ctx_init(device_ref);\n\n    AVHWDeviceContext* hw_device_ctx = (AVHWDeviceContext*)device_ref->data;\n    AVD3D11VADeviceContext* hw_d3d_ctx = (AVD3D11VADeviceContext*)hw_device_ctx->hwctx;\n\n    ID3D11DeviceContext* pD3dDeviceContext = hw_d3d_ctx->device_context;\n    ID3D11Device* pD3dDevice = hw_d3d_ctx->device;\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"pD3dDevice"),"\u548c",(0,a.kt)("inlineCode",{parentName:"p"},"pD3dDeviceContext"),"\u4e3a\u83b7\u53d6\u5230\u7684D3D11\u7684\u5bf9\u8c61\uff0c\u5c06\u5229\u7528\u5b83\u4eec\u8fdb\u884c\u5c4f\u5e55\u6355\u83b7\u3002"),(0,a.kt)("h2",{id:"dxgi\u5c4f\u5e55\u6355\u83b7"},"DXGI\u5c4f\u5e55\u6355\u83b7"),(0,a.kt)("p",null,"\u83b7\u53d6\u5230D3D\u5bf9\u8c61\u540e\uff0c\u8fdb\u4e00\u6b65\u83b7\u53d6DXGI\u76f8\u5173\u5bf9\u8c61\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},'    IDXGIDevice* pDxgiDevice;\n    pD3dDevice->QueryInterface(IID_PPV_ARGS(&pDxgiDevice));\n\n    IDXGIAdapter* pDxgiAdapter;\n    hr = pDxgiDevice->GetParent(IID_PPV_ARGS(&pDxgiAdapter));\n\n    UINT i = 0;\n    IDXGIOutput* pOutput;\n    std::vector<IDXGIOutput*> vOutputs;\n    while (pDxgiAdapter->EnumOutputs(i, &pOutput) != DXGI_ERROR_NOT_FOUND)\n    {\n        vOutputs.push_back(pOutput);\n        ++i;\n    }\n\n    IDXGIOutput1* pDxgiOutput1;\n    vOutputs[0]->QueryInterface(IID_PPV_ARGS(&pDxgiOutput1));\n\n    IDXGIOutputDuplication* pDxgiOutputDuplication;\n    pDxgiOutput1->DuplicateOutput(pD3dDevice, &pDxgiOutputDuplication);\n\n    DXGI_OUTDUPL_DESC mDxgiOutDupDesc;\n    pDxgiOutputDuplication->GetDesc(&mDxgiOutDupDesc);\n\n    std::cout << mDxgiOutDupDesc.ModeDesc.Width << "x";\n    std::cout << mDxgiOutDupDesc.ModeDesc.Height << "@";\n    std::cout << mDxgiOutDupDesc.ModeDesc.RefreshRate.Numerator / mDxgiOutDupDesc.ModeDesc.RefreshRate.Denominator << "Hz" << std::endl;\n')),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"vOutputs"),"\u4e2d\u5b58\u653e\u7684\u662f\u6240\u6709\u663e\u793a\u5668\u4fe1\u606f\uff0c\u521d\u59cb\u5316\u65f6\u7528\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"vOutputs[0]"),"\uff0c\u8868\u793a\u7b2c\u4e00\u4e2a\u663e\u793a\u5668\u3002",(0,a.kt)("inlineCode",{parentName:"p"},"pDxgiOutputDuplication"),"\u5bf9\u8c61\u53ef\u7528\u4e8e\u83b7\u53d6\u5c4f\u5e55\uff0c\u901a\u8fc7\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"AcquireNextFrame"),"\u65b9\u6cd5\u3002\u8be5\u65b9\u6cd5\u8fd4\u56de\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"IDXGIResource"),"\u5bf9\u8c61\uff0c\u53ef\u901a\u8fc7\u4e0b\u5217\u4ee3\u7801\u4ece\u8be5Resource\u4e2d\u83b7\u53d6\u5230\u5305\u542b\u684c\u9762\u56fe\u50cf\u6570\u636e\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"ID3D112DTexture"),"\u5bf9\u8c61\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},"    ID3D11Texture2D* pAcquiredDesktopImage;\n    hr = pDxgiOutputDuplication->AcquireNextFrame(1, &mFrameInfo, &pDesktopRes);\n    if (SUCCEEDED(hr))\n    {\n        pDesktopRes->QueryInterface(IID_PPV_ARGS(&pAcquiredDesktopImage));\n        pDesktopRes->Release();\n    }\n")),(0,a.kt)("p",null,"\u83b7\u53d6\u5230\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"pAcquiredDesktopImage"),"\u4e3aD3D\u7684\u4e8c\u7ef4\u7eb9\u7406\u5bf9\u8c61\uff0c\u5185\u90e8\u7684\u56fe\u7247\u6570\u636e\u5b58\u5728\u4e8e\u663e\u5b58\u4e2d\uff0c\u683c\u5f0f\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"},"BGRA"),"\u3002"),(0,a.kt)("h2",{id:"\u521b\u5efaffmpeg\u786c\u4ef6\u7f16\u7801\u5668"},"\u521b\u5efaFFMPEG\u786c\u4ef6\u7f16\u7801\u5668"),(0,a.kt)("p",null,"FFMPEG\u7f16\u7801\u5668\u7684\u9ed8\u8ba4\u5b9e\u73b0\u662f\u8f6f\u4ef6\u5b9e\u73b0\uff0c\u7f16\u7801\u65f6\u5360\u7528CPU\u8d44\u6e90\u3002\u6839\u636e\u5e73\u53f0\u4e0d\u540c\uff0c\u53ef\u4ee5\u521b\u5efa\u5bf9\u5e94\u7684\u786c\u4ef6\u7f16\u7801\u5668\uff0c\u5e76\u8fdb\u884c\u76f8\u5e94\u914d\u7f6e\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},'    // \u521b\u5efa\u5e76\u914d\u7f6e\u786c\u4ef6\u7f16\u7801\u5668\n    const AVCodec* codec = avcodec_find_encoder_by_name("h264_nvenc");   // NVDIA\u5e73\u53f0\n    // const AVCodec* codec = avcodec_find_encoder_by_name("h264_amf");  // AMD\u5e73\u53f0\n    AVCodecContext* codec_ctx = avcodec_alloc_context3(codec);\n\n    const int TARGET_FPS = 60;\n\n    codec_ctx->width = 1920;\n    codec_ctx->height = 1080;\n    codec_ctx->pix_fmt = AV_PIX_FMT_D3D11;\n    codec_ctx->time_base = AVRational{ 1, TARGET_FPS };\n    codec_ctx->framerate = AVRational{ TARGET_FPS, 1 };\n    codec_ctx->sample_aspect_ratio = AVRational{ 1, 1 }; \n    codec_ctx->gop_size = 10;\n    codec_ctx->max_b_frames = 1;\n')),(0,a.kt)("p",null,"\u9700\u8981\u6ce8\u610f\u7684\u662f",(0,a.kt)("inlineCode",{parentName:"p"},"pix_fmt"),"\u53c2\u6570\uff0c\u6b64\u5904\u5e94\u9009\u62e9",(0,a.kt)("inlineCode",{parentName:"p"},"AV_PIX_FMT_D3D11"),"\uff0c\u8fd9\u6837FFMPEG\u5c31\u4f1a\u4f7f\u7528D3D11\u5728GPU\u4e2d\u521b\u5efa\u5e27\u7f13\u5b58\uff0c\u800c\u4e0d\u662f\u5728\u5185\u5b58\u4e2d\u3002\u8fd9\u4e00\u6b65\u5f88\u91cd\u8981\uff0c\u7531\u4e8eDDA\u91c7\u96c6\u5230\u7684\u5e27\u662fD3D\u8d44\u6e90\uff0c\u5b58\u5728\u663e\u5b58\u4e2d\uff0c\u800c\u5e95\u5c42\u786c\u4ef6\u7f16\u7801\u5668\u7684\u5e27\u7f13\u5b58\u4e5f\u5728\u663e\u5b58\u4e2d\uff0c\u5982\u679cFFMPEG\u7684\u5e27\u7f13\u5b58\u5206\u914d\u5728\u5185\u5b58\u4e2d\uff0c\u7f16\u7801\u65f6\u5c31\u4f1a\u4ea7\u751f ",(0,a.kt)("inlineCode",{parentName:"p"},"\u663e\u5b58->\u5185\u5b58->\u663e\u5b58"),"\u7684\u62f7\u8d1d\uff0c\u800c\u5185\u5b58\u548c\u663e\u5b58\u4e4b\u95f4\u7684\u62f7\u8d1d\u6d88\u8017CPU\u8d44\u6e90\uff0c\u4e14\u4f1a\u964d\u4f4e\u6027\u80fd\u3002\u800c\u5982\u679c\u4f7f\u7528\u663e\u5b58\u5185\u5e27\u7f13\u5b58\uff0c\u5219\u6240\u6709\u7684\u62f7\u8d1d\u64cd\u4f5c\u90fd\u5728\u663e\u5b58\u5185\u5b8c\u6210\uff0c\u5219\u5b8c\u5168\u4e0d\u4f1a\u5360\u7528CPU\u8d44\u6e90\uff0c\u6027\u80fd\u6781\u9ad8\u3002"),(0,a.kt)("h2",{id:"\u521b\u5efa\u684c\u9762\u5e27\u7f13\u5b58\u548cffpmeg\u7f16\u7801\u5668\u5e27\u7f13\u5b58"},"\u521b\u5efa\u684c\u9762\u5e27\u7f13\u5b58\u548cFFPMEG\u7f16\u7801\u5668\u5e27\u7f13\u5b58"),(0,a.kt)("p",null,"DDA\u6709\u4e00\u4e2a\u7279\u6027\uff0c\u5f53\u684c\u9762\u4e0d\u53d1\u751f\u53d8\u5316\u65f6\u6355\u83b7\u4e0d\u5230\u753b\u9762\uff0c\u4e5f\u5c31\u662f\u53ea\u6709\u684c\u9762\u53d8\u5316\u624d\u80fd\u83b7\u53d6\u5230\u65b0\u7684\u5e27\u3002\u800c\u89c6\u9891\u7f16\u7801\u5668\u8981\u6c42\u6bcf\u4e00\u5e27\u8fde\u7eed\u8f93\u5165\uff0c\u56e0\u6b64\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u684c\u9762\u5e27\u7f13\u5b58\uff0c\u5f53\u684c\u9762\u4e0d\u53d8\u65f6\u76f4\u63a5\u4f7f\u7528\u7f13\u5b58\u7684\u5e27\u8f93\u5165\u7f16\u7801\u5668\u3002\u540c\u6837\uff0c\u6211\u4eec\u5728GPU\u4e2d\u5206\u914d\u6765\u907f\u514d\u5185\u5b58\u548c\u663e\u5b58\u95f4\u7684\u62f7\u8d1d\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},"    D3D11_TEXTURE2D_DESC resDesc;\n    ZeroMemory(&resDesc, sizeof(D3D11_TEXTURE2D_DESC));\n    resDesc.Width = 1920;\n    resDesc.Height = 1080;\n    resDesc.MipLevels = 1;\n    resDesc.ArraySize = 1;\n    resDesc.Format = DXGI_FORMAT_B8G8R8A8_UNORM;\n    resDesc.SampleDesc.Count = 1;\n    resDesc.Usage = D3D11_USAGE_DEFAULT;\n    resDesc.BindFlags = D3D11_BIND_RENDER_TARGET;\n    resDesc.CPUAccessFlags = 0;\n\n    ID3D11Texture2D* pCaptureBuffer;\n    pD3dDevice->CreateTexture2D(&resDesc, NULL, &pCaptureBuffer);\n")),(0,a.kt)("p",null,"\u63a5\u4e0b\u6765\u4e3aFFMPEG\u5206\u914d\u5e27\u7f13\u5b58\uff0c \u5e76\u6253\u5f00\u7f16\u7801\u5668\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},"    AVBufferRef* hw_frames_ref;\n    AVHWFramesContext* frame_ctx = NULL;\n\n    hw_frames_ref = av_hwframe_ctx_alloc(device_ref);\n    frame_ctx = (AVHWFramesContext*)(hw_frames_ref->data);\n    frame_ctx->format = AV_PIX_FMT_D3D11;\n    frame_ctx->sw_format = AV_PIX_FMT_BGRA;\n    frame_ctx->width = 1920;\n    frame_ctx->height = 1080;\n    frame_ctx->initial_pool_size = 20;\n\n    ret = av_hwframe_ctx_init(hw_frames_ref);\n    codec_ctx->hw_frames_ctx = av_buffer_ref(hw_frames_ref);\n    av_buffer_unref(&hw_frames_ref);\n    ret = avcodec_open2(codec_ctx, codec, NULL);\n")),(0,a.kt)("h2",{id:"\u5faa\u73af\u7f16\u7801\u5e76\u5199\u5165\u6587\u4ef6\u6d41"},"\u5faa\u73af\u7f16\u7801\u5e76\u5199\u5165\u6587\u4ef6\u6d41"),(0,a.kt)("p",null,"\u4ee5\u4e0b\u4ee3\u7801\u521b\u5efa\u8f93\u51fa\u6587\u4ef6\u6d41\u3001\u5199\u5165\u6587\u4ef6\u5934\u3001\u5faa\u73af\u7f16\u7801\u5e76\u5199\u5165\u6587\u4ef6\u3001\u5199\u5165\u6587\u4ef6\u5c3e\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},'    int64_t calc_duration = av_q2d(codec_ctx->time_base) / av_q2d(vst->time_base);\n    int64_t frame_duration = av_q2d(codec_ctx->time_base) * 1000000;\n    int64_t last_frame_time = av_gettime();\n\n    while (frameCount <= RECORD_PERIOD * TARGET_FPS)\n    {\n        last_frame_time = av_gettime();\n        hr = pDxgiOutputDuplication->AcquireNextFrame(1, &mFrameInfo, &pDesktopRes);\n\n        if (SUCCEEDED(hr))\n        {\n            pDesktopRes->QueryInterface(IID_PPV_ARGS(&pAcquiredDesktopImage));\n            pDesktopRes->Release();\n\n            pD3dDeviceContext->CopyResource(pCaptureBuffer, pAcquiredDesktopImage);\n\n            pAcquiredDesktopImage->Release();\n            pDxgiOutputDuplication->ReleaseFrame();\n        }\n\n        AVFrame* hw_frame = av_frame_alloc();\n        ret = av_hwframe_get_buffer(codec_ctx->hw_frames_ctx, hw_frame, 0);\n        if (ret < 0)\n        {\n            return ret;\n        }\n        if (!hw_frame->hw_frames_ctx) \n        {\n            return AVERROR(ENOMEM);\n        }\n\n        hw_frame->data[0] = (uint8_t*)pCaptureBuffer;\n        hw_frame->data[1] = 0;\n\n        ret = avcodec_send_frame(codec_ctx, hw_frame);\n        if (ret < 0)\n        {\n            return ret;\n        }\n        std::cout << "frameCount: " << frameCount << std::endl;\n        AVPacket* packet = av_packet_alloc();\n\n        while (true)\n        {\n            ret = avcodec_receive_packet(codec_ctx, packet);\n            if (ret) break;\n            packet->stream_index = vst -> index;\n            packet->duration = calc_duration;\n            packet->pts = frameCount * packet->duration;\n            packet->dts = packet -> pts;\n\n            ret = av_interleaved_write_frame(fmt_ctx_out, packet);\n\n            av_packet_unref(packet);\n        }\n        av_frame_free(&hw_frame);\n        av_packet_free(&packet);\n        \n        frameCount++;\n\n        auto sleepTime = frame_duration - (av_gettime() - last_frame_time);\n        if (sleepTime > 0) av_usleep((unsigned int)sleepTime);\n    }\n\n    av_write_trailer(fmt_ctx_out);\n    avformat_free_context(fmt_ctx_out);\n')),(0,a.kt)("p",null,"\u7531\u4e8e\u662f\u7b80\u5355Demo\uff0c\u8fd9\u91cc\u7684\u5f55\u5236\u5faa\u73af\u56fa\u5b9a\u5f55\u523620\u79d2\u3002\u4e3a\u4fdd\u8bc1\u7f16\u7801\u901f\u5ea6\u548c\u5b9e\u9645\u901f\u5ea6\u5339\u914d\uff0c\u5728\u7f16\u7801\u8fc7\u7a0b\u4e2d\u4f1a\u8ba1\u7b97\u6bcf\u4e00\u5e27\u7684\u6355\u83b7\u53ca\u7f16\u7801\u8017\u65f6\uff0c\u5e76\u5728\u4e0e\u5e27\u7387\u5339\u914d\u7684\u6b63\u786e\u65f6\u95f4\u70b9\u8fdb\u884c\u4e0b\u4e00\u5e27\u7684\u6355\u83b7\u548c\u7f16\u7801\u3002\u5176\u4f59FFMPEG\u76f8\u5173\u51fd\u6570\u8bf4\u660e\u6b64\u5904\u65e0\u9700\u8d58\u8ff0\uff0c\u8bfb\u8005\u53ef\u81ea\u884c\u67e5\u9605\u5b98\u65b9\u6587\u6863\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"\u8fd0\u884c\u6548\u679c\u56fe.png",src:n(5230).Z,width:"1500",height:"679"})))}l.isMDXComponent=!0},5230:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/figure-cd72b47df98023b486cc5c050162dc13.png"}}]);